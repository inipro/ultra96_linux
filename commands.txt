* chapter 1 - section 3

<step 3-1>
~$ sudo dpkg-reconfigure dash

<step 3-3>
~$ sudo apt install iproute2 gawk python3 build-essential gcc git make net-tools libncurses5-dev tftpd zlib1g-dev libssl-dev flex bison libselinux1 gnupg wget git-core diffstat chrpath socat xterm autoconf libtool tar unzip texinfo zlib1g-dev gcc-multilib automake zlib1g:i386 screen pax gzip cpio python3-pip python3-pexpect xz-utils debianutils iputils-ping python3-git python3-jinja2 libegl1-mesa libsdl1.2-dev pylint lz4 libtinfo5

<step 3-4>
~$ sudo apt update
~$ sudo apt upgrade

<step 3-5>
~$ sudo apt install minicom
~$ echo "pu rtscts No" > ~/.minirc.dfl
~$ sudo usermod -a -G dialout $USER

<step 3-6>
~$ git config --global user.name "Your Name"
~$ git config --global user.email "Your Email"

* chapter 1 - section 4

<step 2-1>
~$ cd ~/Downloads
~$ chmod 755 FPGAs_AdaptiveSoCs_Unified_2023.2_1013_2256_Lin64.bin

<step 2-2>
~$ sudo ./FPGAs_AdaptiveSoCs_Unified_2023.2_1013_2256_Lin64.bin

<step 2-12>
~$ cd /tools/Xilinx/Vivado/2023.2/data/xicom/cable_drivers/lin64/install_script/install_drivers/
~$ sudo ./install_drivers

<step 2-13>
~$ source /tools/Xilinx/Vivado/2023.2/settings64.sh
~$ vivado

<step 2-14>
~$ source /tools/Xilinx/Vitis/2023.2/settings64.sh
~$ vitis

<step 2-16>
~$ cd ~/Downloads
~$ git clone https://github.com/Avnet/bdf.git
~$ mkdir ~/board_files
~$ cp -r bdf/ultra96v2 ~/board_files
~$ cd ~/.Xilinx/Vivado/2023.2/
~$ echo "set_param board.repoPaths [list $::env(HOME)/board_files]" > Vivado_init.tcl

* chapter 1 - section 5

<step 2-1>
~$ chmod 755 ./Downloads/petalinux-v2023.2-10121855-installer.run

<step 2-2>
~$ sudo mkdir -p /tools/Xilinx/PetaLinux/2023.2
~$ sudo chown -R $USER:$USER /tools/Xilinx/PetaLinux

<step 2-3>
~$ ./Downloads/petalinux-v2023.2-10121855-installer.run --dir /tools/Xilinx/PetaLinux/2023.2/

<step 2-7>
~$ source /tools/Xilinx/PetaLinux/2023.2/settings.sh

<step 2-8>
~$ vi ~/.bashrc
source /tools/Xilinx/Vitis/2023.2/settings64.sh
source /tools/Xilinx/PetaLinux/2023.2/settings.sh > /dev/null

<step 2-9>
~$ cd ~/Downloads
~$ tar -xvzf downloads_2023.tgz -C /tools/Xilinx/PetaLinux
~$ tar -xvzf sstate-cache_2023_ultra96.tgz -C /tools/Xilinx/PetaLinux

* chapter 2 

~$ sudo apt install vim tree

* chapter 2 - section 2

<step 1>
~$ mkdir ~/work
~$ git clone -b 2023.2 https://github.com/inipro/ultra96_linux.git

<step 2-1>
~$ cd ~/work/ultra96_linux/vivado
~$ vivado -nolog -nojournal -source base.tcl

<step 2-2>
~$ cd ~/work/ultra96_linux/plnx
~$ petalinux-create -t project -s ultra96_base.bsp

<step 2-3>
~$ vi ultra96_base/project-spec/configs/config
~$ petalinux-package --force --bsp --clean -o ultra96_base.bsp -p ultra96_base

<step 2-4>
~$ cd ultra96_base
~$ petalinux-build
~$ petalinux-package --wic --wks project-spec/meta-user/wic/petalinux-image-minimal.wks --bootfiles "BOOT.BIN boot.scr Image system.dtb" --wic-extra-args "-c xz"

<step 2-5>
~$ mkdir ../output
~$ cp images/linux/petalinux-sdimage.wic.xz ../output
~$ cd ..
~$ rm -fr ultra96_base

<step 3-2>
~$ minicom -D /dev/ttyUSB1

<step 3-5>
ultra96:~$ sudo vi /home/root/wpa_supplicant.conf
ultra96:~$ sudo /home/root/wifi.sh
ultra96:~$ ifconfig

<step 3-6>
~$ ssh petalinux@<your-ultra96-ip>

<step 3-7>
~$ ifconfig

<step 3-8>
ultra96:~$ sudo vi /etc/hosts
<your-desktop-ip> myrepo
ultra96:~$ sudo poweroff

* chapter 2 - section 3

<step 1>
~$ cd ~/work/ultra96_linux/plnx
~$ petalinux-create -t project -n ultra96_autostart -s ultra96_base.bsp
~$ cd ultra96_autostart

<step 2-1>
~$ petalinux-build -c qt5everywheredemo

<step 2-2>
~$ petalinux-build -c package-index

<step 2-3>
~$ cd ~/work/ultra96_linux/plnx/ultra96_autostart/build/tmp/deploy/rpm
~$ python3 -m http.server 5678

<step 2-4>
ultra96:~$ sudo dnf -y --refresh install qt5everywheredemo

<step 2-5>
ultra96:~$ /usr/share/qt5everywheredemo-1.0/QtDemo -platform eglfs

<step 3-1>
~$ cp -r ../meta-user/recipes-apps/autostart/ project-spec/meta-user/recipes-apps
~$ view project-spec/meta-user/recipes-apps/autostart/autostart.bb
~$ view project-spec/meta-user/recipes-apps/autostart/files/autostart.sh

<step 3-2>
~$ petalinux-build -c autostart
~$ petalinux-build -c package-index

<step 3-3>
ultra96:~$ sudo dnf -y --refresh install autostart

<step 3-4>
ultra96:~$ sudo reboot

<step 4-1>
~$ vi project-spec/meta-user/conf/user-rootfsconfig
CONFIG_autostart
~$ petalinux-config -c rootfs

<step 4-2>
~$ petalinux-build
~$ petalinux-package --wic --wks project-spec/meta-user/wic/petalinux-image-minimal.wks --bootfiles "BOOT.BIN boot.scr Image system.dtb" --wic-extra-args "-c xz"

<step 4-3>
~$ mkdir ../output/autostart
~$ cp images/linux/petalinux-sdimage.wic.xz ../output/autostart
~$ cd ..
~$ petalinux-package --force --bsp --clean -o ultra96_autostart.bsp -p ultra96_autostart
~$ rm -fr ultra96_autostart

* chapter 2 - section 4

<step 1-1>
~$ cd ~/work/ultra96_linux/vivado
~$ vivado -nolog -nojournal -source sensor.tcl

<step 1-2>
~$ cd ~/work/ultra96_linux/plnx
~$ petalinux-create -t project -n ultra96_sensor -s ultra96_base.bsp
~$ cd ultra96_sensor
~$ mkdir -p project-spec/meta-user/recipes-firmware/sensor-fw/files
~$ cp ../../vivado/sensor/sensor_wrapper.xsa project-spec/meta-user/recipes-firmware/sensor-fw/files/
~$ cp ../meta-user/recipes-firmware/sensor-fw/files/pl-custom.dtsi project-spec/meta-user/recipes-firmware/sensor-fw/files/
~$ cd project-spec/meta-user/recipes-firmware/sensor-fw/files/
~$ ln -s ../../../recipes-bsp/device-tree/files/0001-Add-avnet-ultra96-ver2.patch
~$ cd -
~$ cp ../meta-user/recipes-firmware/sensor-fw/sensor-fw.bb project-spec/meta-user/recipes-firmware/sensor-fw/
~$ tree project-spec/meta-user/recipes-firmware/sensor-fw/
~$ cp -r ../meta-user/recipes-modules/pmodals/ project-spec/meta-user/recipes-modules
~$ view project-spec/meta-user/recipes-firmware/sensor-fw/sensor-fw.bb
~$ view project-spec/meta-user/recipes-firmware/sensor-fw/files/pl-custom.dtsi
~$ petalinux-build -c sensor-fw -x configure
~$ view build/tmp/work/zynqmp_generic_xczu3eg-xilinx-linux/sensor-fw/1.0-r0/build/sensor-fw/psu_cortexa53_0/device_tree_domain/bsp/pl.dtsi

<step 2-1>
~$ petalinux-build -c sensor-fw
~$ petalinux-build -c package-index

<step 2-2>
~$ cd ~/work/ultra96_linux/plnx/ultra96_sensor/build/tmp/deploy/rpm
~$ python3 -m http.server 5678

<step 2-3>
ultra96:~$ sudo dnf -y --refresh install sensor-fw
ultra96:~$ sudo fpgautil -b /lib/firmware/xilinx/sensor-fw/sensor-fw.bit.bin -o /lib/firmware/xilinx/sensor-fw/sensor-fw.dtbo

<step 2-4>
ultra96:~$ lsmod

<step 2-5>
ultra96:~$ cat /sys/devices/platform/axi/80000000.axi_quad_spi/spi_master/spi2/spi2.0/adc

<step 3-1>
~$ cp -r ../meta-user/recipes-apps/sensor-app project-spec/meta-user/recipes-apps/
~$ petalinux-build -c sensor-app
~$ petalinux-build -c package-index

<step 3-2>
ultra96:~$ sudo dnf -y --refresh install sensor-app
ultra96:~$ sensor-app -platform eglfs
~$ tree project-spec/meta-user/recipes-apps/sensor-app/files/
ultra96:~$ rm -fr .cache/sensor-app

<step 4-1>
~$ vi project-spec/meta-user/recipes-apps/fw-autoload/files/fw-autoload.sh
base_path="/lib/firmware/xilinx/sensor-fw"
bit_file="sensor-fw.bit.bin"
dtb_file="sensor-fw.dtbo"

<step 4-2>
~$ cp -r ../meta-user/recipes-apps/autostart/ project-spec/meta-user/recipes-apps/
~$ vi project-spec/meta-user/recipes-apps/autostart/autostart.bb
sensor-app
~$ vi project-spec/meta-user/recipes-apps/autostart/files/autostart.sh
/usr/bin/sensor-app -platform eglfs

<step 4-3>
~$ petalinux-build -c fw-autoload
~$ petalinux-build -c autostart
~$ petalinux-build -c package-index
ultra96:~$ sudo dnf -y --refresh remove fw-autoload
ultra96:~$ sudo dnf -y --refresh install fw-autoload
ultra96:~$ sudo dnf -y --refresh install autostart
ultra96:~$ sudo reboot

<step 5-1>
~$ vi project-spec/meta-user/conf/user-rootfsconfig
CONFIG_autostart
~$ petalinux-config -c rootfs

<step 5-2>
~$ petalinux-build
~$ petalinux-package --wic --wks project-spec/meta-user/wic/petalinux-image-minimal.wks --bootfiles "BOOT.BIN boot.scr Image system.dtb" --wic-extra-args "-c xz"

<step 5-3>
~$ mkdir ../output/sensor
~$ cp images/linux/petalinux-sdimage.wic.xz ../output/sensor
~$ cd ..
~$ petalinux-package --force --bsp --clean -o ultra96_sensor.bsp -p ultra96_sensor
~$ rm -fr ultra96_sensor

* chapter 2 - section 5

<step 1-1>
~$ cd ~/work/ultra96_linux/vivado
~$ vivado -nolog -nojournal -source vadd.tcl

<step 1-2>
~$ cd ~/work/ultra96_linux/plnx
~$ petalinux-create -t project -n ultra96_vadd -s ultra96_base.bsp
~$ cd ultra96_vadd
~$ mkdir -p project-spec/meta-user/recipes-firmware/vadd-fw/files
~$ cp ../../vivado/vadd/vadd_wrapper.xsa project-spec/meta-user/recipes-firmware/vadd-fw/files/
~$ cp ../meta-user/recipes-firmware/vadd-fw/files/pl-custom.dtsi project-spec/meta-user/recipes-firmware/vadd-fw/files/
~$ cd project-spec/meta-user/recipes-firmware/vadd-fw/files/
~$ ln -s ../../../recipes-bsp/device-tree/files/0001-Add-avnet-ultra96-ver2.patch
~$ cd -
~$ cp ../meta-user/recipes-firmware/vadd-fw/vadd-fw.bb project-spec/meta-user/recipes-firmware/vadd-fw/
~$ tree project-spec/meta-user/recipes-firmware/vadd-fw/
~$ cp -r ../meta-user/recipes-modules/mygem/ project-spec/meta-user/recipes-modules
~$ view project-spec/meta-user/recipes-firmware/vadd-fw/vadd-fw.bb
~$ view project-spec/meta-user/recipes-firmware/vadd-fw/files/pl-custom.dtsi
~$ petalinux-build -c vadd-fw -x configure
~$ view build/tmp/work/zynqmp_generic_xczu3eg-xilinx-linux/vadd-fw/1.0-r0/build/vadd-fw/psu_cortexa53_0/device_tree_domain/bsp/pl.dtsi
~$ view project-spec/configs/config
ultra96:~$ cat /proc/cmdline

<step 2-1>
~$ petalinux-build -c vadd-fw
~$ petalinux-build -c package-index

<step 2-2>
~$ cd ~/work/ultra96_linux/plnx/ultra96_vadd/build/tmp/deploy/rpm
~$ python3 -m http.server 5678

<step 2-3>
ultra96:~$ sudo dnf -y --refresh install vadd-fw
ultra96:~$ sudo fpgautil -b /lib/firmware/xilinx/vadd-fw/vadd-fw.bit.bin -o /lib/firmware/xilinx/vadd-fw/vadd-fw.dtbo

<step 2-4>
ultra96:~$ lsmod

<step 2-5>
ultra96:~$ ls -l /sys/class/uio/
ultra96:~$ ls /dev/uio4
ultra96:~$ ls -l /dev/dri/by-path/
ultra96:~$ cat /proc/interrupts

<step 3-1>
~$ cp -r ../meta-user/recipes-apps/vadd-app/ project-spec/meta-user/recipes-apps/
~$ petalinux-build -c vadd-app
~$ petalinux-build -c package-index

<step 3-2>
ultra96:~$ sudo dnf -y --refresh install vadd-app
ultra96:~$ sudo vadd-app
ultra96:~$ dmesg
ultra96:~$ cat /proc/interrupts

<step 4-1>
~$ vi project-spec/meta-user/recipes-apps/fw-autoload/files/fw-autoload.sh
base_path="/lib/firmware/xilinx/vadd-fw"
bit_file="vadd-fw.bit.bin"
dtb_file="vadd-fw.dtbo"

<step 4-2>
~$ vi project-spec/meta-user/conf/user-rootfsconfig
CONFIG_vadd-app
~$ petalinux-config -c rootfs

<step 4-3>
~$ petalinux-build
~$ petalinux-package --wic --wks project-spec/meta-user/wic/petalinux-image-minimal.wks --bootfiles "BOOT.BIN boot.scr Image system.dtb" --wic-extra-args "-c xz"

<step 4-4>
~$ mkdir ../output/vadd
~$ cp images/linux/petalinux-sdimage.wic.xz ../output/vadd
~$ cd ..
~$ petalinux-package --force --bsp --clean -o ultra96_vadd.bsp -p ultra96_vadd
~$ rm -fr ultra96_vadd

* chapter 2 - section 6

<step 1>
~$ cd ~/work/ultra96_linux/vivado
~$ vivado -nolog -nojournal -source pcam5c.tcl

<step 2-1>
~$ cd ~/work/ultra96_linux/plnx
~$ petalinux-create -t project -n ultra96_pcam5c -s ultra96_base.bsp
~$ cd ultra96_pcam5c
~$ petalinux-build -c linux-xlnx -x configure
~$ petalinux-devtool modify linux-xlnx

<step 2-2>
~$ cd ~/work/ultra96_linux/plnx/ultra96_pcam5c/components/yocto/workspace/sources/linux-xlnx/
~$ git log --oneline -5

<step 2-3>
~$ vi drivers/media/i2c/ov5640.c

        if (sensor->current_mode->pixel_rate == OV5640_PIXEL_RATE_148M) sysclk = 120000000U * ov5640_code_to_bpp(sensor, sensor->fmt.code)/(2 *sensor->ep.bus.mipi_csi2.num_data_lanes);

~$ git diff

<step 2-4>
~$ petalinux-devtool menuconfig linux-xlnx

<step 2-7>
~$ petalinux-build -c linux-xlnx
~$ ls images/linux/Image

<step 2-8>
ultra96:~$ sudo poweroff
~$ cp images/linux/Image /media/$USER/boot
~$ sync

<step 2-9>
ultra96:~$ zcat /proc/config.gz | grep OV5640

<step 3-1>
~$ cd ~/work/ultra96_linux/plnx/ultra96_pcam5c
~$ mkdir -p project-spec/meta-user/recipes-firmware/pcam5c-fw/files
~$ cp ../../vivado/pcam5c/pcam5c_wrapper.xsa project-spec/meta-user/recipes-firmware/pcam5c-fw/files/
~$ cp ../meta-user/recipes-firmware/pcam5c-fw/files/pl-custom.dtsi project-spec/meta-user/recipes-firmware/pcam5c-fw/files/
~$ cd project-spec/meta-user/recipes-firmware/pcam5c-fw/files/
~$ ln -s ../../../recipes-bsp/device-tree/files/0001-Add-avnet-ultra96-ver2.patch
~$ cd -
~$ cp ../meta-user/recipes-firmware/pcam5c-fw/pcam5c-fw.bb project-spec/meta-user/recipes-firmware/pcam5c-fw/
~$ tree project-spec/meta-user/recipes-firmware/pcam5c-fw/
~$ view project-spec/meta-user/recipes-firmware/pcam5c-fw/pcam5c-fw.bb
~$ view project-spec/meta-user/recipes-firmware/pcam5c-fw/files/pl-custom.dtsi
~$ petalinux-build -c pcam5c-fw -x configure
~$ view build/tmp/work/zynqmp_generic_xczu3eg-xilinx-linux/pcam5c-fw/1.0-r0/build/pcam5c-fw/psu_cortexa53_0/device_tree_domain/bsp/pl.dtsi

<step 3-2>
~$ petalinux-build -c pcam5c-fw
~$ petalinux-build -c package-index

<step 3-3>
~$ cd ~/work/ultra96_linux/plnx/ultra96_pcam5c/build/tmp/deploy/rpm
~$ python3 -m http.server 5678

<step 3-4>
ultra96:~$ sudo dnf -y --refresh install pcam5c-fw
ultra96:~$ sudo fpgautil -b /lib/firmware/xilinx/pcam5c-fw/pcam5c-fw.bit.bin -o /lib/firmware/xilinx/pcam5c-fw/pcam5c-fw.dtbo

<step 3-5>
ultra96:~$ ls /dev/media0
ultra96:~$ media-ctl -d /dev/media0 -p

<step 3-6>
ultra96:~$ media-ctl -d /dev/media0 -V '"ov5640 3-003c":0 [fmt:UYVY/1920x1080 field:none]'
ultra96:~$ media-ctl -d /dev/media0 -V '"80020000.v_proc_ss":0 [fmt:UYVY/1920x1080 field:none]'
ultra96:~$ media-ctl -d /dev/media0 -p

<step 3-7>
ultra96:~$ ls -l /dev/dri/by-path/
ultra96:~$ modetest -D fd4a0000.display

<step 3-8>
ultra96:~$ gst-launch-1.0 -v v4l2src device=/dev/video0 io-mode=5 ! capsfilter caps=video/x-raw,width=1920,height=1080,format=RGB !  kmssink bus-id=fd4a0000.display plane-id=41

<step 4-1>
~$ cp -r ../meta-user/recipes-apps/video-app/ project-spec/meta-user/recipes-apps/
~$ petalinux-build -c video-app
~$ petalinux-build -c package-index

<step 4-2>
ultra96:~$ sudo dnf -y --refresh install video-app
ultra96:~$ video-app

<step 5-1>
~$ vi project-spec/meta-user/recipes-apps/fw-autoload/files/fw-autoload.sh
base_path="/lib/firmware/xilinx/pcam5c-fw"
bit_file="pcam5c-fw.bit.bin"
dtb_file="pcam5c-fw.dtbo"

<step 5-2>
~$ cp -r ../meta-user/recipes-apps/autostart/ project-spec/meta-user/recipes-apps/
~$ vi project-spec/meta-user/recipes-apps/autostart/autostart.bb
video-app
~$ vi project-spec/meta-user/recipes-apps/autostart/files/autostart.sh
/usr/bin/video-app

<step 5-3>
~$ petalinux-build -c fw-autoload
~$ petalinux-build -c autostart
~$ petalinux-build -c package-index
ultra96:~$ sudo dnf -y --refresh remove fw-autoload
ultra96:~$ sudo dnf -y --refresh install fw-autoload
ultra96:~$ sudo dnf -y --refresh install autostart
ultra96:~$ sudo reboot

<step 6-1>
~$ git add drivers/media/i2c/ov5640.c
~$ git commit -s -m "Modify mipi clock reg"

<step 6-2>
~$ cat oe-local-files/devtool-fragment.cfg >> oe-local-files/bsp.cfg
~$ rm oe-local-files/devtool-fragment.cfg
~$ cp .config.new .config.baseline

<step 6-3>
~$ tree project-spec/meta-user/recipes-kernel/linux/
~$ view project-spec/meta-user/recipes-kernel/linux/linux-xlnx_%.bbappend
~$ view project-spec/meta-user/recipes-kernel/linux/linux-xlnx_2023.2.bbappend
~$ tail project-spec/meta-user/recipes-kernel/linux/linux-xlnx/bsp.cfg

<step 6-4>
~$ exit

<step 6-5>
~$ petalinux-devtool update-recipe -n -a ../project-spec/meta-user linux-xlnx
~$ tree project-spec/meta-user/recipes-kernel/linux/
~$ view project-spec/meta-user/recipes-kernel/linux/linux-xlnx_%.bbappend
~$ view project-spec/meta-user/recipes-kernel/linux/linux-xlnx_2023.2.bbappend
~$ tail project-spec/meta-user/recipes-kernel/linux/linux-xlnx/bsp.cfg
~$ view project-spec/meta-user/recipes-kernel/linux/linux-xlnx/0001-Modify-mipi-clock-reg.patch

<step 6-6>
~$ petalinux-devtool reset -r linux-xlnx

<step 6-7>
~$ vi project-spec/meta-user/conf/user-rootfsconfig
CONFIG_autostart
~$ petalinux-config -c rootfs

<step 6-8>
~$ petalinux-build
~$ petalinux-package --wic --wks project-spec/meta-user/wic/petalinux-image-minimal.wks --bootfiles "BOOT.BIN boot.scr Image system.dtb" --wic-extra-args "-c xz"

<step 6-9>
~$ mkdir -p ../output/pcam5c
~$ cp images/linux/petalinux-sdimage.wic.xz ../output/pcam5c
~$ cd ..
~$ petalinux-package --force --bsp --clean -o ultra96_pcam5c.bsp -p ultra96_pcam5c
~$ rm -fr ultra96_pcam5c
